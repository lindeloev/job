---
title: "Debug code using controlled environments"
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

Running `job`s in clean sessions is a great to test code without having to launch new RStudios.


# Empty session
Here's an embarrassing error I commit too often: Say I want to write a function that computes the Mean Squared Error (MSE) of a numerical vector. First, I fiddle around with it in the console, ending up with:

```{r}
tmp = rnorm(1000, sd = 2)
mean((tmp - mean(tmp))^2)
```

It works! Then I wrap the code in a function and try it out:

```{r}
mse = function(x) {
  mean((tmp - mean(tmp))^2)
}

mse(rnorm(1000, sd = 1))
```

Huh!? It runs but the MSE should be around 1 here, not 4. Time for debugging! Let's select the code and run it using the addin "Run selection as job in empty session". Or do the same in code by calling `job::job_empty()`:

```{r, eval = FALSE}
job::job_empty({
  mse = function(x) {
    mean((tmp - mean(tmp))^2)
  }

  mse(rnorm(1000, sd = 1))
})
```

In the job, you'll see the error message:

```{r}
# Error in mean((tmp - mean(tmp))^2) : object 'tmp' not found 
```

Aha, by running the code in a separate session, we learned that it only *seemed* to work because I had the `tmp` variable lingering in my environment. You probably caught this immediately in this overly simple example (right?). It becomes less trivial with code involving more variables, nested calls, etc.


# testthat unit tests
If you just write a simple `testthat` script, it has access to your current environment. The proper fix is to re-write your tests using `testthat::test_that()` but a lazy solution is to simply use `job::job_empty()`:

```{r, eval = FALSE}
job::job_empty(devtools::test())
```

This also frees up your console in the meantime.



# Selected import
Continuing the example above, you can, of course, `import` selectively too. Starting from `job::job_empty()` rather than `job::job()` is convenient here:

```{r, eval = FALSE}
job::job_empty({
  mse(rnorm(1000, sd = 1))
}, import = c(mse))
```

